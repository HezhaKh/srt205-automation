# CIS Compliance Report for {{ inventory_hostname }}

**Date:** {{ ansible_date_time.date if ansible_date_time is defined else 'N/A' }}
**Mode:** {{ ac_mode | default(cis_mode | default('audit')) }}

{# -- Normalize possibly-different shapes to lists ------------------------ #}
{% macro norm_lines(v) -%}
{%- if v is not defined -%}
{%- set _ = [] -%}
{%- elif v is mapping and v.stdout_lines is defined -%}
{{- v.stdout_lines -}}
{%- elif v is mapping and v.stdout is defined -%}
{{- v.stdout.splitlines() -}}
{%- elif v is sequence and not (v is string) -%}
{{- v -}}
{%- elif v is string -%}
{{- [v] -}}
{%- else -%}
{{- [] -}}
{%- endif -%}
{%- endmacro %}

{% set login_defs_lines = norm_lines(_login_defs) | list %}
{% set pwq_lines        = norm_lines(_pwq)        | list %}
{% set sshd_lines       = norm_lines(_sshd)       | list %}
{% set sysctl_lines     = norm_lines(_sysctl)     | list %}
{% set ufw_lines        = norm_lines(_ufw)        | list %}
{% set cron_at_lines    = norm_lines(_cron_at)    | list %}
{% set tmp_mount_lines  = norm_lines(_tmp_mount)  | list %}
{% set timesync_lines   = norm_lines(_timesync)   | list %}
{% set sudo_raw         = norm_lines(_sudo_log)   | list %}
{% set sudo_log_lines   = sudo_raw | map('regex_replace', '\\\\n', '\n') | list %}

---

## Summary of Security Configurations
- Password Aging: {{ login_defs_lines | join(', ') if login_defs_lines else 'N/A' }}
- Password Quality: {{ pwq_lines | join(', ') if pwq_lines else 'N/A' }}
- SSHD Config: {{ sshd_lines | join(', ') if sshd_lines else 'N/A' }}
- Sysctl Settings: {{ sysctl_lines | join(', ') if sysctl_lines else 'N/A' }}

{# ---- Firewall: prefer firewalld if present, else UFW, else N/A -------- #}
{% if firewalld_state is defined or firewalld_default_zone is defined or (firewalld_services is defined and (firewalld_services|length>0)) %}
- Firewall (firewalld) Status: {{ firewalld_state | default('unknown') }}{% if firewalld_default_zone is defined and firewalld_default_zone|length>0 %}; Default zone: {{ firewalld_default_zone }}{% endif %}{% if firewalld_services is defined and (firewalld_services|length>0) %}; Services: {{ (firewalld_services if firewalld_services is sequence and not (firewalld_services is string) else [firewalld_services]) | join(', ') }}{% endif %}
{% elif ufw_lines and (ufw_lines|length>0) %}
- UFW Status: {{ ufw_lines | join('; ') }}
{% else %}
- Firewall: N/A
{% endif %}

{% if cron_at_lines and (cron_at_lines|length>0) %}
## Cron & At Restrictions
{{ cron_at_lines | join('\n') }}
{% endif %}

{% if tmp_mount_lines and (tmp_mount_lines|length>0) %}
## /tmp Mount Options
{{ tmp_mount_lines | join('\n') }}
{% endif %}

{% if timesync_lines and (timesync_lines|length>0) %}
## Time Synchronization
{{ timesync_lines | join('\n') }}
{% endif %}

{% if sudo_log_lines and (sudo_log_lines|length>0) %}
## Sudo Logging
{{ sudo_log_lines | join('\n') }}
{% endif %}

---

## Non-Compliant Issues
{% if non_compliant_items is defined and (non_compliant_items | length > 0) %}
{% for item in non_compliant_items %}- {{ item }}
{% endfor %}
{% else %}No non-compliance detected.
{% endif %}

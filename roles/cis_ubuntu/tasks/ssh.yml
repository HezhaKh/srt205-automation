---
# I think this is better code hygin but also a idempotence automation killer!
#- name: Check if legacy drop-in exists
#  ansible.builtin.stat:
#    path: /etc/ssh/sshd_config.d/*ansible*
#  register: _old_dropin

#- name: Remove legacy drop-in
#  ansible.builtin.file:
#    path: "{{ _old_dropin.stat.path }}"
#    state: absent
#  when: _old_dropin.stat.exists

# Changes when file content is actually modified
- name: Template hardened sshd drop-in
  ansible.builtin.template:
    src: sshd_10-ansible.conf.j2
    dest: /etc/ssh/sshd_config.d/10-ansible.conf
    owner: root
    group: root
    mode: '0644'
  notify: Reload sshd

- name: Audit sshd effective settings
  shell: "sshd -T 2>/dev/null | egrep '^(permitrootlogin|maxauthtries|x11forwarding|loglevel|clientaliveinterval|clientalivecountmax|port|passwordauthentication)'"
  register: sshd_effective
  changed_when: false
  failed_when: false
  when: cis_mode == 'audit'

- name: Normalize sshd audit lines for report
  set_fact:
    sshd_effective: "{{ sshd_effective }}"
  when: cis_mode == 'audit'
